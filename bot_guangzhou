import os
import logging
import json
import random
import threading
import time
from datetime import datetime, timedelta
from telegram import Update, ReplyKeyboardMarkup, KeyboardButton
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes, ConversationHandler
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ì—É–∞–Ω—á–∂–æ—É
from config_guangzhou import GUANGZHOU_CONFIG

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()
TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')

# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –¥–∏–∞–ª–æ–≥–∞
WAITING_FIO, WAITING_PRODUCT, WAITING_WEIGHT, WAITING_VOLUME, WAITING_PHONE = range(5)

class GuangzhouBot:
    def __init__(self):
        self.token = TOKEN
        self.config = GUANGZHOU_CONFIG
        self.data_file = "data/guangzhou_track_data.json"
        self.application = None
        self.deadline_tasks = {}
        self.setup_bot()
        self.setup_deadline_checker()
    
    def setup_bot(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞"""
        if not self.token:
            logger.error("‚ùå –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª .env")
            return
        
        self.application = Application.builder().token(self.token).build()
        self.setup_handlers()
    
    def setup_handlers(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥"""
        # –ö–æ–º–∞–Ω–¥–∞ /start
        self.application.add_handler(CommandHandler("start", self.start_command))
        
        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –≥—Ä—É–∑–∞
        conv_handler = ConversationHandler(
            entry_points=[MessageHandler(filters.Regex('^(‚ûï –ù–û–í–´–ô –ì–†–£–ó)$'), self.new_shipment_start)],
            states={
                WAITING_FIO: [MessageHandler(filters.TEXT & ~filters.COMMAND, self.get_fio)],
                WAITING_PRODUCT: [MessageHandler(filters.TEXT & ~filters.COMMAND, self.get_product)],
                WAITING_WEIGHT: [MessageHandler(filters.TEXT & ~filters.COMMAND, self.get_weight)],
                WAITING_VOLUME: [MessageHandler(filters.TEXT & ~filters.COMMAND, self.get_volume)],
                WAITING_PHONE: [MessageHandler(filters.TEXT & ~filters.COMMAND, self.get_phone)],
            },
            fallbacks=[CommandHandler('cancel', self.cancel_command)]
        )
        
        self.application.add_handler(conv_handler)
        
        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
        self.application.add_handler(MessageHandler(filters.Regex('^(üì¶ –ú–û–ò –ì–†–£–ó–´)$'), self.my_shipments))
        self.application.add_handler(MessageHandler(filters.Regex('^(üöö –û–¢–ü–†–ê–í–õ–ï–ù–û)$'), self.quick_sent))
        self.application.add_handler(MessageHandler(filters.Regex('^(üõÉ –ù–ê –ì–†–ê–ù–ò–¶–ï)$'), self.quick_border))
        self.application.add_handler(MessageHandler(filters.Regex('^(‚úÖ –î–û–°–¢–ê–í–õ–ï–ù–û)$'), self.quick_delivered))
        
        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç—Ä–µ–∫-–Ω–æ–º–µ—Ä–æ–≤
        self.application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, self.handle_track_number))
    
    def setup_deadline_checker(self):
        """–ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–µ–¥–ª–∞–π–Ω–æ–≤"""
        def deadline_checker():
            while True:
                try:
                    self.check_shipment_deadlines()
                    time.sleep(3600)  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–π —á–∞—Å
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–µ–¥–ª–∞–π–Ω–æ–≤: {e}")
                    time.sleep(300)  # –ñ–¥–µ–º 5 –º–∏–Ω—É—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ
        
        thread = threading.Thread(target=deadline_checker, daemon=True)
        thread.start()
    
    def check_shipment_deadlines(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–¥–ª–∞–π–Ω–æ–≤ –ø–æ –≥—Ä—É–∑–∞–º (–±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω–µ–¥–∂–µ—Ä—É)"""
        try:
            shipments = self.get_all_shipments()
            current_time = datetime.now()
            
            for track_number, shipment in shipments.items():
                if shipment.get('status') == '–ø—Ä–∏–Ω—è—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ':
                    created_at = datetime.fromisoformat(shipment['created_at'])
                    deadline = created_at + timedelta(days=self.config['deadlines']['processing_time'])
                    
                    # –õ–æ–≥–∏—Ä—É–µ–º –ø—Ä–æ—Å—Ä–æ—á–∫—É, –Ω–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    if current_time > deadline and not shipment.get('deadline_notified'):
                        logger.warning(f"üö® –ü–†–û–°–†–û–ß–ö–ê: {track_number} - –º–µ–Ω–µ–¥–∂–µ—Ä {shipment.get('manager')}")
                        shipment['deadline_notified'] = True
                        shipment['deadline_missed'] = True  # –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π
                        self.save_shipment_data(track_number, shipment)
                    
                    # –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ 12 —á–∞—Å–æ–≤ –¥–æ –¥–µ–¥–ª–∞–π–Ω–∞ (—Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä—É–µ–º)
                    elif current_time > deadline - timedelta(hours=12) and not shipment.get('reminder_sent'):
                        logger.info(f"‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: {track_number} - –¥–µ–¥–ª–∞–π–Ω —á–µ—Ä–µ–∑ 12 —á–∞—Å–æ–≤")
                        shipment['reminder_sent'] = True
                        self.save_shipment_data(track_number, shipment)
                        
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–µ–¥–ª–∞–π–Ω–æ–≤: {e}")
    
    def generate_track_number(self):
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç—Ä–µ–∫-–Ω–æ–º–µ—Ä–∞ –¥–ª—è –ì—É–∞–Ω—á–∂–æ—É"""
        number = random.randint(100000, 999999)
        return f"GZ{number}"

    def save_shipment_data(self, track_number, data):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≥—Ä—É–∑–∞ –≤ —Ñ–∞–π–ª –ì—É–∞–Ω—á–∂–æ—É"""
        try:
            # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ
            if os.path.exists(self.data_file):
                with open(self.data_file, 'r', encoding='utf-8') as f:
                    all_data = json.load(f)
            else:
                all_data = {}
            
            # –î–û–ë–ê–í–¨ –≠–¢–ò –°–¢–†–û–ö–ò –î–õ–Ø –û–¢–õ–ê–î–ö–ò:
            print(f"üîß –î–û–ë–ê–í–õ–Ø–ï–ú –ì–†–£–ó: {track_number}")
            print(f"üîß –§–∞–π–ª: {self.data_file}")
            print(f"üîß –î–∞–Ω–Ω—ã–µ: {data}")
            
            # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –≥—Ä—É–∑
            all_data[track_number] = data
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—Ä–∞—Ç–Ω–æ
            with open(self.data_file, 'w', encoding='utf-8') as f:
                json.dump(all_data, f, ensure_ascii=False, indent=2)
            
            # –î–û–ë–ê–í–¨ –≠–¢–£ –°–¢–†–û–ö–£:
            print(f"‚úÖ –ì—Ä—É–∑ {track_number} –£–°–ü–ï–®–ù–û –°–û–•–†–ê–ù–ï–ù!")
            
            logger.info(f"‚úÖ –ì—Ä—É–∑ {track_number} —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ {self.data_file}")
            
        except Exception as e:
            # –î–û–ë–ê–í–¨ –≠–¢–£ –°–¢–†–û–ö–£:
            print(f"‚ùå –û–®–ò–ë–ö–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø: {e}")
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: {e}")
            
    def load_shipment_data(self, track_number):
        """–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≥—Ä—É–∑–∞ –∏–∑ —Ñ–∞–π–ª–∞ –ì—É–∞–Ω—á–∂–æ—É"""
        try:
            if not os.path.exists(self.data_file):
                return None
            
            with open(self.data_file, 'r', encoding='utf-8') as f:
                all_data = json.load(f)
            
            return all_data.get(track_number)
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: {e}")
            return None
    
    def get_all_shipments(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –≥—Ä—É–∑–æ–≤ –ì—É–∞–Ω—á–∂–æ—É"""
        try:
            if os.path.exists(self.data_file):
                with open(self.data_file, 'r', encoding='utf-8') as f:
                    return json.load(f)
            return {}
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –≥—Ä—É–∑–æ–≤: {e}")
            return {}
    
    async def start_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ö–æ–º–∞–Ω–¥–∞ /start - –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
        user = update.message.from_user
        
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
        keyboard = [
            [KeyboardButton("‚ûï –ù–û–í–´–ô –ì–†–£–ó")],
            [KeyboardButton("üì¶ –ú–û–ò –ì–†–£–ó–´")],
            [KeyboardButton("üöö –û–¢–ü–†–ê–í–õ–ï–ù–û"), KeyboardButton("üõÉ –ù–ê –ì–†–ê–ù–ò–¶–ï"), KeyboardButton("‚úÖ –î–û–°–¢–ê–í–õ–ï–ù–û")]
        ]
        reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
        
        welcome_text = f"""üè≠ POST PRO - –°–ö–õ–ê–î –ì–£–ê–ù–ß–ñ–û–£

üë§ –ú–µ–Ω–µ–¥–∂–µ—Ä: {user.first_name}
üìç –°–∫–ª–∞–¥: {self.config['warehouse_city']}

üìã –û–°–ù–û–í–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø:

‚ûï –ù–û–í–´–ô –ì–†–£–ó - –ü—Ä–∏–Ω—è—Ç—å –≥—Ä—É–∑ –Ω–∞ —Å–∫–ª–∞–¥
üì¶ –ú–û–ò –ì–†–£–ó–´ - –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –≥—Ä—É–∑–æ–≤

‚ö° –ë–´–°–¢–†–´–ï –°–¢–ê–¢–£–°–´:
üöö –û–¢–ü–†–ê–í–õ–ï–ù–û - –ì—Ä—É–∑ –≤ –ø—É—Ç–∏
üõÉ –ù–ê –ì–†–ê–ù–ò–¶–ï - –ù–∞ –≥—Ä–∞–Ω–∏—Ü–µ  
‚úÖ –î–û–°–¢–ê–í–õ–ï–ù–û - –î–æ—Å—Ç–∞–≤–ª–µ–Ω

üí° –í—Å–µ –≥—Ä—É–∑—ã –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å GZ (GZ123456)"""
        
        await update.message.reply_text(welcome_text, reply_markup=reply_markup)
    
    async def new_shipment_start(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ù–∞—á–∞–ª–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –≥—Ä—É–∑–∞"""
        await update.message.reply_text(
            "üè≠ **–ù–û–í–´–ô –ì–†–£–ó - –°–ö–õ–ê–î –ì–£–ê–ù–ß–ñ–û–£**\n\n"
            "üë§ –í–≤–µ–¥–∏—Ç–µ –§–ò–û –ø–æ–ª—É—á–∞—Ç–µ–ª—è:\n"
            "–ü—Ä–∏–º–µ—Ä: '–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á'"
        )
        return WAITING_FIO

    async def get_fio(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –§–ò–û"""
        fio = update.message.text
        context.user_data['fio'] = fio
        
        await update.message.reply_text(
            f"‚úÖ –§–ò–û: {fio}\n\n"
            "üì¶ –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:\n"
            "–ü—Ä–∏–º–µ—Ä: '–ú–µ–±–µ–ª—å –∏–∑ –ò–∫–µ–∞', '–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞ Xiaomi'"
        )
        return WAITING_PRODUCT

    async def get_product(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞"""
        product = update.message.text
        context.user_data['product'] = product
        
        await update.message.reply_text(
            f"‚úÖ –¢–æ–≤–∞—Ä: {product}\n\n"
            "‚öñÔ∏è –í–≤–µ–¥–∏—Ç–µ –≤–µ—Å –≥—Ä—É–∑–∞ (–∫–≥):\n"
            "–ü—Ä–∏–º–µ—Ä: 150"
        )
        return WAITING_WEIGHT

    async def get_weight(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –≤–µ—Å–∞"""
        try:
            weight = float(update.message.text)
            context.user_data['weight'] = weight
            
            await update.message.reply_text(
                f"‚úÖ –í–µ—Å: {weight} –∫–≥\n\n"
                "üìè –í–≤–µ–¥–∏—Ç–µ –æ–±—ä–µ–º –≥—Ä—É–∑–∞ (–º¬≥):\n"
                "–ü—Ä–∏–º–µ—Ä: 2.5"
            )
            return WAITING_VOLUME
        except ValueError:
            await update.message.reply_text("‚ùå –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –¥–ª—è –≤–µ—Å–∞:")
            return WAITING_WEIGHT

    async def get_volume(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—ä–µ–º–∞"""
        try:
            volume = float(update.message.text)
            context.user_data['volume'] = volume
            
            await update.message.reply_text(
                f"‚úÖ –û–±—ä–µ–º: {volume} –º¬≥\n\n"
                "üìû –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞:\n"
                "–ü—Ä–∏–º–µ—Ä: '+77001234567'"
            )
            return WAITING_PHONE
        except ValueError:
            await update.message.reply_text("‚ùå –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –¥–ª—è –æ–±—ä–µ–º–∞:")
            return WAITING_VOLUME

    async def get_phone(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è"""
        print("üéØ –î–û–°–¢–ò–ì–õ–ò –ú–ï–¢–û–î–ê get_phone!")  # –î–û–ë–ê–í–¨ –≠–¢–£ –°–¢–†–û–ö–£
        print(f"üìû –ü–æ–ª—É—á–µ–Ω —Ç–µ–ª–µ—Ñ–æ–Ω: {update.message.text}")  # –î–û–ë–ê–í–¨ –≠–¢–£ –°–¢–†–û–ö–£
    
        phone = update.message.text
        context.user_data['phone'] = phone
    
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç—Ä–µ–∫-–Ω–æ–º–µ—Ä
        track_number = self.generate_track_number()
    
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
        shipment_data = {
        "track_number": track_number,
        "fio": context.user_data['fio'],
        "product": context.user_data['product'],
        "weight": context.user_data['weight'],
        "volume": context.user_data['volume'],
        "phone": context.user_data['phone'],
        "status": "–ø—Ä–∏–Ω—è—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ",
        "warehouse": self.config['warehouse_name'],
        "manager": update.message.from_user.first_name,
        "manager_chat_id": update.message.chat_id,
        "created_at": datetime.now().isoformat(),
        "route_progress": 0,
        "deadline_notified": False,
        "reminder_sent": False,
        "deadline_missed": False
    }
    
        self.save_shipment_data(track_number, shipment_data)
    
        # –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        context.user_data.clear()
    
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        await self.start_command(update, context)
    
        # –°–æ–æ–±—â–∞–µ–º –æ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –¥–µ–¥–ª–∞–π–Ω–µ
        deadline = datetime.now() + timedelta(days=self.config['deadlines']['processing_time'])
    
        await update.message.reply_text(
        f"üéâ **–ù–û–í–´–ô –ì–†–£–ó –°–û–ó–î–ê–ù!**\n\n"
        f"üî¢ –¢—Ä–µ–∫-–Ω–æ–º–µ—Ä: {track_number}\n"
        f"üë§ –ö–ª–∏–µ–Ω—Ç: {shipment_data['fio']}\n"
        f"üì¶ –¢–æ–≤–∞—Ä: {shipment_data['product']}\n\n"
        f"‚è∞ **–î–ï–î–õ–ê–ô–ù –û–¢–ü–†–ê–í–ö–ò:**\n"
        f"üìÖ {deadline.strftime('%d.%m.%Y %H:%M')}\n"
        f"‚è±Ô∏è –û—Å—Ç–∞–ª–æ—Å—å: {self.config['deadlines']['processing_time']} –¥–Ω–µ–π\n\n"
        f"üöö –ù–∞–∂–º–∏—Ç–µ '–û–¢–ü–†–ê–í–õ–ï–ù–û' –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å—Ä–æ–∫–∞!"
    )
    
        return ConversationHandler.END

    async def cancel_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û—Ç–º–µ–Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏"""
        context.user_data.clear()
        await update.message.reply_text("‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.")
        await self.start_command(update, context)
        return ConversationHandler.END

    async def my_shipments(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–°–ø–∏—Å–æ–∫ –º–æ–∏—Ö –≥—Ä—É–∑–æ–≤"""
        shipments = self.get_all_shipments()
        
        if not shipments:
            await update.message.reply_text(
                "üì¶ –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≥—Ä—É–∑–æ–≤.\n\n"
                "–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –≥—Ä—É–∑ —Å –ø–æ–º–æ—â—å—é –∫–Ω–æ–ø–∫–∏ '‚ûï –ù–û–í–´–ô –ì–†–£–ó'"
            )
            return
        
        response = "üì¶ **–í–ê–®–ò –ì–†–£–ó–´:**\n\n"
        
        for track_number, shipment in list(shipments.items())[:10]:  # –ü–µ—Ä–≤—ã–µ 10
            status_emoji = {
                "–ø—Ä–∏–Ω—è—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ": "üè≠",
                "–≤ –ø—É—Ç–∏ –¥–æ –≥—Ä–∞–Ω–∏—Ü—ã": "üöö",
                "–Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ": "üõÉ", 
                "–≤ –ø—É—Ç–∏ –¥–æ –∞–ª–º–∞—Ç—ã": "üöõ",
                "–ø—Ä–∏–±—ã–ª –≤ –∞–ª–º–∞—Ç—ã": "üèôÔ∏è",
                "–¥–æ—Å—Ç–∞–≤–ª–µ–Ω": "‚úÖ"
            }.get(shipment.get('status', ''), 'üì¶')
            
            # –ü–æ–º–µ—á–∞–µ–º –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –≥—Ä—É–∑—ã
            deadline_warning = ""
            if shipment.get('deadline_missed'):
                deadline_warning = " ‚ö†Ô∏è –ü–†–û–°–†–û–ß–ï–ù"
            elif shipment.get('status') == '–ø—Ä–∏–Ω—è—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ':
                created_at = datetime.fromisoformat(shipment['created_at'])
                deadline = created_at + timedelta(days=self.config['deadlines']['processing_time'])
                if datetime.now() > deadline - timedelta(hours=12):
                    deadline_warning = " ‚è∞ –°–ö–û–†–û –î–ï–î–õ–ê–ô–ù"
            
            response += f"{status_emoji} **{track_number}**{deadline_warning}\n"
            response += f"   üë§ {shipment.get('fio', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            response += f"   üì¶ {shipment.get('product', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            response += f"   üîÑ {shipment.get('status', '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω')}\n"
            response += f"   üìÖ {shipment.get('created_at', '')[:10]}\n\n"
        
        await update.message.reply_text(response)

    async def quick_sent(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ë—ã—Å—Ç—Ä–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ '–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'"""
        context.user_data['quick_action'] = 'sent'
        await update.message.reply_text(
            "üöö **–û–¢–ü–†–ê–í–ö–ê –ì–†–£–ó–ê**\n\n"
            "–í–≤–µ–¥–∏—Ç–µ —Ç—Ä–µ–∫-–Ω–æ–º–µ—Ä –≥—Ä—É–∑–∞ (GZ123456):"
        )

    async def quick_border(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ë—ã—Å—Ç—Ä–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ '–Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ'"""
        context.user_data['quick_action'] = 'border'
        await update.message.reply_text(
            "üõÉ **–ì–†–£–ó –ù–ê –ì–†–ê–ù–ò–¶–ï**\n\n"
            "–í–≤–µ–¥–∏—Ç–µ —Ç—Ä–µ–∫-–Ω–æ–º–µ—Ä –≥—Ä—É–∑–∞ (GZ123456):"
        )

    async def quick_delivered(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ë—ã—Å—Ç—Ä–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ '–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ'"""
        context.user_data['quick_action'] = 'delivered'
        await update.message.reply_text(
            "‚úÖ **–î–û–°–¢–ê–í–ö–ê –ì–†–£–ó–ê**\n\n"
            "–í–≤–µ–¥–∏—Ç–µ —Ç—Ä–µ–∫-–Ω–æ–º–µ—Ä –≥—Ä—É–∑–∞ (GZ123456):"
        )

    async def handle_track_number(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç—Ä–µ–∫-–Ω–æ–º–µ—Ä–æ–≤"""
        track_number = update.message.text.strip().upper()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç —Ç—Ä–µ–∫-–Ω–æ–º–µ—Ä–∞ –ì—É–∞–Ω—á–∂–æ—É
        if not (track_number.startswith('GZ') and len(track_number) == 8 and track_number[2:].isdigit()):
            await update.message.reply_text(
                "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç—Ä–µ–∫-–Ω–æ–º–µ—Ä–∞.\n"
                "–¢—Ä–µ–∫-–Ω–æ–º–µ—Ä –ì—É–∞–Ω—á–∂–æ—É: GZ123456\n\n"
                "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏."
            )
            return
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≥—Ä—É–∑–∞
        shipment = self.load_shipment_data(track_number)
        if not shipment:
            await update.message.reply_text(
                f"‚ùå –ì—Ä—É–∑ {track_number} –Ω–µ –Ω–∞–π–¥–µ–Ω.\n"
                "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç—Ä–µ–∫-–Ω–æ–º–µ—Ä –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –≥—Ä—É–∑."
            )
            return
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å –æ–∂–∏–¥–∞—é—â–∏–π —Å—Ç–∞—Ç—É—Å - –æ–±–Ω–æ–≤–ª—è–µ–º
        if 'quick_action' in context.user_data:
            action = context.user_data['quick_action']
            
            if action == 'sent':
                await self.update_status_sent(update, track_number, shipment)
            elif action == 'border':
                await self.update_status_border(update, track_number, shipment)
            elif action == 'delivered':
                await self.update_status_delivered(update, track_number, shipment)
            
            context.user_data.pop('quick_action', None)
        else:
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥—Ä—É–∑–µ
            await self.show_shipment_info(update, shipment)

    async def update_status_sent(self, update: Update, track_number: str, shipment: dict):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ '–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'"""
        shipment['status'] = "–≤ –ø—É—Ç–∏ –¥–æ –≥—Ä–∞–Ω–∏—Ü—ã"
        shipment['route_progress'] = 10
        self.save_shipment_data(track_number, shipment)
        
        await update.message.reply_text(
            f"üöö **–ì–†–£–ó –û–¢–ü–†–ê–í–õ–ï–ù!**\n\n"
            f"–¢—Ä–µ–∫-–Ω–æ–º–µ—Ä: {track_number}\n"
            f"üìç –ù–∞—á–∞–ª –¥–≤–∏–∂–µ–Ω–∏–µ –∏–∑ –ì—É–∞–Ω—á–∂–æ—É\n"
            f"üõ£Ô∏è –°–ª–µ–¥—É–µ–º –¥–æ –≥—Ä–∞–Ω–∏—Ü—ã –•–æ—Ä–≥–æ—Å"
        )

    async def update_status_border(self, update: Update, track_number: str, shipment: dict):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ '–Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ'"""
        shipment['status'] = "–Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ"
        shipment['route_progress'] = 85
        self.save_shipment_data(track_number, shipment)
        
        await update.message.reply_text(
            f"üõÉ **–ì–†–£–ó –ù–ê –ì–†–ê–ù–ò–¶–ï!**\n\n"
            f"–¢—Ä–µ–∫-–Ω–æ–º–µ—Ä: {track_number}\n"
            f"üìç –•–æ—Ä–≥–æ—Å (–≥—Ä–∞–Ω–∏—Ü–∞ –ö–∏—Ç–∞–π-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω)\n"
            f"üìã –ü—Ä–æ—Ö–æ–¥–∏—Ç —Ç–∞–º–æ–∂–µ–Ω–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ"
        )

    async def update_status_delivered(self, update: Update, track_number: str, shipment: dict):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ '–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ'"""
        shipment['status'] = "–¥–æ—Å—Ç–∞–≤–ª–µ–Ω"
        shipment['route_progress'] = 100
        self.save_shipment_data(track_number, shipment)
        
        await update.message.reply_text(
            f"‚úÖ **–ì–†–£–ó –î–û–°–¢–ê–í–õ–ï–ù!**\n\n"
            f"–¢—Ä–µ–∫-–Ω–æ–º–µ—Ä: {track_number}\n"
            f"üìç –î–æ—Å—Ç–∞–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞\n"
            f"üéâ –ö–ª–∏–µ–Ω—Ç: {shipment.get('fio', '–ù–µ —É–∫–∞–∑–∞–Ω')}"
        )

    async def show_shipment_info(self, update: Update, shipment: dict):
        """–ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥—Ä—É–∑–µ"""
        response = f"üì¶ **–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ì–†–£–ó–ï**\n\n"
        response += f"üî¢ –¢—Ä–µ–∫-–Ω–æ–º–µ—Ä: {shipment['track_number']}\n"
        response += f"üë§ –ö–ª–∏–µ–Ω—Ç: {shipment.get('fio', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
        response += f"üìû –¢–µ–ª–µ—Ñ–æ–Ω: {shipment.get('phone', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
        response += f"üì¶ –¢–æ–≤–∞—Ä: {shipment.get('product', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
        response += f"‚öñÔ∏è –í–µ—Å: {shipment.get('weight', 0)} –∫–≥\n"
        response += f"üìè –û–±—ä–µ–º: {shipment.get('volume', 0)} –º¬≥\n"
        response += f"üîÑ –°—Ç–∞—Ç—É—Å: {shipment.get('status', '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω')}\n"
        response += f"üìç –°–∫–ª–∞–¥: {shipment.get('warehouse', '–ì—É–∞–Ω—á–∂–æ—É')}\n"
        response += f"üë®‚Äçüíº –ú–µ–Ω–µ–¥–∂–µ—Ä: {shipment.get('manager', '–ù–µ —É–∫–∞–∑–∞–Ω')}\n"
        response += f"üìÖ –°–æ–∑–¥–∞–Ω: {shipment.get('created_at', '')[:10]}\n\n"
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–µ–¥–ª–∞–π–Ω–µ –¥–ª—è –≥—Ä—É–∑–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–µ
        if shipment.get('status') == '–ø—Ä–∏–Ω—è—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ':
            created_at = datetime.fromisoformat(shipment['created_at'])
            deadline = created_at + timedelta(days=self.config['deadlines']['processing_time'])
            time_left = deadline - datetime.now()
            
            if time_left.total_seconds() > 0:
                response += f"‚è∞ **–î–ï–î–õ–ê–ô–ù –û–¢–ü–†–ê–í–ö–ò:**\n"
                response += f"üìÖ {deadline.strftime('%d.%m.%Y %H:%M')}\n"
                response += f"‚è±Ô∏è –û—Å—Ç–∞–ª–æ—Å—å: {int(time_left.total_seconds() / 3600)} —á–∞—Å–æ–≤\n\n"
            else:
                response += f"‚ö†Ô∏è **–î–ï–î–õ–ê–ô–ù –ü–†–û–°–†–û–ß–ï–ù!**\n"
                response += f"üïí –ü—Ä–æ—Å—Ä–æ—á–∫–∞: {int(-time_left.total_seconds() / 3600)} —á–∞—Å–æ–≤\n\n"
        
        response += f"üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±—ã—Å—Ç—Ä—ã–µ —Å—Ç–∞—Ç—É—Å—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
        
        await update.message.reply_text(response)

    def run(self):
        """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
        if self.application:
            logger.info("üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ì—É–∞–Ω—á–∂–æ—É...")
            self.application.run_polling()
        else:
            logger.error("‚ùå –ë–æ—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!")

if __name__ == '__main__':
    bot = GuangzhouBot()
    bot.run()
